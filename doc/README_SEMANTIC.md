# MiniSwift 语义分析器

## 概述

MiniSwift 语义分析器是一个完整的 Swift 语言语义分析系统，支持类型检查、符号表管理和 LLVM IR 代码生成。该系统为 MiniSwift 解释器提供了静态分析能力，并为未来的编译器功能奠定了基础。

## 功能特性

### 1. 语义分析器 (SemanticAnalyzer)
- **AST 遍历**: 使用访问者模式遍历抽象语法树
- **类型检查**: 验证表达式和语句的类型正确性
- **符号解析**: 解析变量、函数和类型引用
- **作用域管理**: 管理嵌套作用域和符号可见性
- **错误报告**: 提供详细的语义错误和警告信息

### 2. 符号表系统 (SymbolTable)
- **分层作用域**: 支持全局、函数、块、类等多种作用域类型
- **符号管理**: 管理变量、函数、类型和模块符号
- **函数重载**: 支持基于参数类型的函数重载
- **继承支持**: 处理类继承关系中的符号查找
- **模块系统**: 支持模块导入和命名空间管理

### 3. 类型系统 (TypeSystem)
- **内置类型**: Int, Float, Bool, String, Void, Any
- **复合类型**: Array, Dictionary, Tuple, Optional
- **函数类型**: 支持函数签名和类型检查
- **用户定义类型**: Struct, Class, Enum
- **泛型支持**: 泛型类型和约束检查
- **类型推断**: 自动推断表达式类型
- **子类型关系**: 支持继承和协议一致性

### 4. 类型化 AST (TypedAST)
- **类型注解**: 为 AST 节点添加类型信息
- **类型化访问者**: 支持类型化 AST 的遍历
- **类型映射**: 维护表达式到类型的映射关系
- **符号信息**: 存储符号的类型和签名信息

### 5. LLVM 代码生成器 (LLVMCodeGenerator)
- **IR 生成**: 将类型化 AST 转换为 LLVM IR
- **JIT 编译**: 支持即时编译和执行
- **AOT 编译**: 支持提前编译到目标代码
- **优化支持**: 集成 LLVM 优化管道
- **目标代码**: 生成机器码和可执行文件

## 架构设计

```
源代码 (Swift)
    ↓
词法分析器 (Lexer)
    ↓
语法分析器 (Parser)
    ↓
抽象语法树 (AST)
    ↓
语义分析器 (SemanticAnalyzer)
    ↓
类型化 AST (TypedAST)
    ↓
┌─────────────────┬─────────────────┐
│   解释执行路径    │   编译执行路径    │
│                │                │
│   解释器        │   LLVM 代码生成器 │
│   (Interpreter) │   (CodeGenerator)│
│       ↓         │       ↓         │
│   直接执行       │   LLVM IR       │
│                │       ↓         │
│                │   LLVM 优化器    │
│                │       ↓         │
│                │ ┌─────┴─────┐    │
│                │ │ JIT 引擎  │AOT │
│                │ │   ↓      │ ↓  │
│                │ │ 内存执行  │机器码│
└─────────────────┴─┴─────────┴────┘
```

## 使用方法

### 编译项目

确保系统已安装 LLVM 开发库：

```bash
# macOS (使用 Homebrew)
brew install llvm

# Ubuntu/Debian
sudo apt-get install llvm-dev

# 编译项目
mkdir build
cd build
cmake ..
make
```

### 命令行选项

```bash
# 基本解释执行
./miniswift script.swift

# 启用语义分析
./miniswift -s script.swift
./miniswift --semantic script.swift

# 启用 LLVM 代码生成
./miniswift -l script.swift
./miniswift --llvm script.swift

# 交互模式
./miniswift
./miniswift -s    # 带语义分析的交互模式
./miniswift -l    # 带 LLVM 代码生成的交互模式

# 帮助信息
./miniswift -h
./miniswift --help
```

### 测试语义分析器

使用提供的测试文件：

```bash
# 运行语义分析
./miniswift -s test_semantic.swift

# 生成 LLVM IR
./miniswift -l test_semantic.swift
```

## 支持的 Swift 特性

### 基本语法
- [x] 变量声明 (`var`, `let`)
- [x] 类型注解和类型推断
- [x] 基本数据类型 (Int, Float, Bool, String)
- [x] 算术和逻辑运算符
- [x] 比较运算符
- [x] 赋值运算符

### 控制流
- [x] 条件语句 (`if`, `else`)
- [x] 循环语句 (`for`, `while`)
- [x] 函数调用和返回
- [x] 作用域管理

### 函数
- [x] 函数定义和调用
- [x] 参数类型检查
- [x] 返回类型验证
- [x] 函数重载
- [x] 递归函数

### 数据结构
- [x] 数组 (`[Type]`)
- [x] 字典 (`[Key: Value]`)
- [x] 元组 (`(Type1, Type2, ...)`)
- [x] 可选类型 (`Type?`)

### 面向对象
- [x] 结构体 (`struct`)
- [x] 类 (`class`)
- [x] 属性和方法
- [x] 构造器 (`init`)
- [x] 继承关系
- [x] 访问控制

### 高级特性
- [x] 泛型类型（基础支持）
- [x] 协议（基础支持）
- [x] 扩展（基础支持）
- [x] 错误处理（基础支持）

## 错误处理

语义分析器能够检测和报告以下类型的错误：

### 类型错误
- 类型不匹配
- 无效的类型转换
- 函数参数类型错误
- 返回类型不匹配

### 符号错误
- 未声明的变量
- 重复声明
- 作用域外访问
- 函数重载冲突

### 语义错误
- 无效的操作
- 循环依赖
- 抽象方法调用
- 访问控制违规

## 性能特性

- **增量分析**: 支持增量语义分析
- **缓存机制**: 缓存类型推断结果
- **并行处理**: 支持并行符号解析
- **内存优化**: 智能内存管理和对象池

## 扩展性

语义分析器采用模块化设计，易于扩展：

- **新类型支持**: 通过继承 `Type` 类添加新类型
- **新语法特性**: 通过扩展访问者模式添加新节点
- **自定义检查**: 通过插件机制添加自定义语义检查
- **目标平台**: 通过 LLVM 后端支持多种目标平台

## 调试和诊断

- **详细错误信息**: 包含行号、列号和上下文
- **警告系统**: 提供代码质量警告
- **调试输出**: 支持符号表和类型系统的调试输出
- **性能分析**: 内置性能分析工具

## 注意：
如果在mac os 15+以上使用 llvm的预编译版本，需要先执行下面的命令
```sh
# 递归移除文件夹下所有文件的隔离属性
xattr -d -r com.apple.quarantine /path/to/your/folder

# 示例（针对您的 llvm 工具文件夹）：
xattr -d -r com.apple.quarantine /tools/llvm/bin
```

## 未来计划

- [ ] 完整的泛型系统
- [ ] 协议和扩展的完整支持
- [ ] 更高级的类型推断
- [ ] 并发和异步支持的语义分析
- [ ] 更多的 LLVM 优化
- [ ] 调试信息生成
- [ ] 增量编译支持

## 贡献指南

欢迎贡献代码和报告问题！请遵循以下指南：

1. 遵循现有的代码风格
2. 添加适当的测试用例
3. 更新相关文档
4. 确保所有测试通过

## 许可证

本项目采用 MIT 许可证。详见 LICENSE 文件。